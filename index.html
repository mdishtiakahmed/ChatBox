<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>লাইভ ভিডিও &amp; চ্যাট</title>
  <style>
    /* Basic Reset & Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background-color: #ece5dd;
      color: #333;
      transition: background-color 0.3s, color 0.3s;
    }
    /* Dark theme (toggle by adding .dark-theme class to body) */
    body.dark-theme {
      background-color: #1e1e1e;
      color: #ddd;
    }
    /* Login Section */
    #loginSection {
      max-width: 400px;
      margin: 80px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    #loginSection h2 {
      text-align: center;
      margin-bottom: 15px;
    }
    #loginSection label,
    #loginSection select,
    #loginSection input,
    #loginSection button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      font-size: 16px;
    }
    #loginSection button {
      background: #075E54;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    #loginSection button:hover {
      background: #0a7a71;
    }
    /* App Section (after login) */
    #appSection {
      display: none;
      height: 100vh;
      flex-direction: column;
    }
    header.header {
      background-color: #075E54;
      color: #fff;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header.header h1 {
      font-size: 20px;
    }
    /* Profile button: 50% rounded */
    .profile-btn {
      background: #fff;
      color: #075E54;
      border: none;
      padding: 8px 12px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: bold;
    }
    /* Main layout: Sidebar & Chat area */
    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    aside.contacts {
      width: 250px;
      background: #f0f0f0;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      padding: 10px;
    }
    aside.contacts h3 {
      margin-bottom: 10px;
      text-align: center;
    }
    aside.contacts ul {
      list-style: none;
    }
    aside.contacts li {
      padding: 10px;
      margin: 5px 0;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    aside.contacts li:hover,
    aside.contacts li.active {
      background: #d0f0d0;
    }
    aside.contacts button {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      background: #075E54;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    /* Chat Section */
    section.chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #e5ddd5;
      position: relative;
    }
    .chat-header {
      background: #075E54;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-header .call-actions button {
      background: #34B7F1;
      color: #fff;
      border: none;
      padding: 6px 10px;
      margin-left: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .message {
      margin: 8px 0;
      max-width: 70%;
      padding: 10px 15px;
      border-radius: 20px;
      word-wrap: break-word;
      font-size: 15px;
      clear: both;
    }
    .message.self {
      background: #dcf8c6;
      float: right;
      text-align: right;
    }
    .message.peer {
      background: #fff;
      float: left;
      text-align: left;
    }
    .message.system {
      background: #e0e0e0;
      text-align: center;
      margin: 10px auto;
      max-width: 90%;
      font-size: 12px;
    }
    /* Chat input area */
    .chat-input-container {
      display: flex;
      padding: 8px;
      background: #f0f0f0;
      align-items: center;
    }
    .chat-input-container input[type="text"] {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .chat-input-container .send-btn {
      padding: 8px 12px;
      margin-left: 5px;
      background: #075E54;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .chat-input-container #fileBtn {
      padding: 8px 12px;
      margin-right: 5px;
      background: #999;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    /* Fixed chat box height */
    .chat-section {
      position: relative;
    }
    /* Fullscreen Modal for Calls */
    .modal {
      display: none;
      position: fixed;
      z-index: 11000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      overflow: auto;
    }
    .modal-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .modal .close {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 40px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      z-index: 12000;
    }
    .video-container {
      position: relative;
      width: 90%;
      max-width: 900px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }
    #remoteVideo {
      width: 100%;
      height: auto;
      background: #000;
    }
    #localVideo {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 200px;
      height: auto;
      border: 2px solid #fff;
      border-radius: 5px;
      transform: scaleX(-1);
    }
    .call-end-btn {
      margin-top: 20px;
      background: #d9534f;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 18px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      aside.contacts { width: 200px; }
      .profile-btn { padding: 6px 10px; }
      #localVideo { width: 120px; }
    }
  </style>
</head>
<body>
  <!-- Login Section -->
  <div id="loginSection">
    <h2>লগইন</h2>
    <label for="accountSelect">একাউন্ট নির্বাচন করুন:</label>
    <select id="accountSelect">
      <option value="account1">Account 1</option>
      <option value="account2">Account 2</option>
      <option value="account3">Account 3</option>
      <option value="account4">Account 4</option>
      <option value="account5">Account 5</option>
      <option value="account6">Account 6</option>
    </select>
    <label for="passwordInput">পাসওয়ার্ড:</label>
    <input type="password" id="passwordInput" placeholder="পাসওয়ার্ড দিন">
    <button id="loginButton">লগইন</button>
  </div>

  <!-- Main App Section -->
  <div id="appSection" class="app-section">
    <header class="header">
      <h1>লাইভ ভিডিও &amp; চ্যাট</h1>
      <!-- Profile button: 50% rounded; ক্লিক করলে থিম পরিবর্তনের অপশন -->
      <button id="profileBtn" class="profile-btn" title="থিম পরিবর্তন করুন">PN</button>
    </header>
    <div class="main">
      <!-- Sidebar: Contact List -->
      <aside class="contacts">
        <h3>কন্টাক্ট</h3>
        <ul id="contactList"></ul>
        <!-- Button to create group chat -->
        <button id="createGroupBtn">নতুন গ্রুপ চ্যাট</button>
      </aside>
      <!-- Chat Area -->
      <section class="chat-section">
        <div class="chat-header">
          <span id="chatWith">মেসেজ</span>
          <div class="call-actions">
            <button id="videoCallBtn">ভিডিও কল</button>
            <button id="audioCallBtn">অডিও কল</button>
          </div>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-container">
          <button id="fileBtn">ফাইল</button>
          <input type="file" id="fileInput" style="display:none">
          <input type="text" id="chatInput" placeholder="মেসেজ লিখুন...">
          <button id="sendChatBtn" class="send-btn">পাঠান</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Fullscreen Modal for Calls -->
  <div id="callModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeCallModal">&times;</span>
      <div class="video-container" id="videoContainer">
        <video id="remoteVideo" autoplay></video>
        <video id="localVideo" autoplay muted></video>
      </div>
      <button id="endCallBtn" class="call-end-btn">কল শেষ করুন</button>
    </div>
  </div>

  <!-- PeerJS Library -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script>
    /***** Global Variables *****/
    let userRole = "";
    let username = "";
    let peer = null;
    // Maintain connections with peers (key: peerId)
    const connections = {};
    // Store conversation histories; key: conversationId, value: array of messages
    const conversations = {};
    // Current active conversation object: { id, participants: [peerId,...] }
    let currentConversation = null;

    /***** DOM Elements *****/
    const loginSection = document.getElementById('loginSection');
    const appSection = document.getElementById('appSection');
    const accountSelect = document.getElementById('accountSelect');
    const passwordInput = document.getElementById('passwordInput');
    const loginButton = document.getElementById('loginButton');

    const profileBtn = document.getElementById('profileBtn');

    const contactListEl = document.getElementById('contactList');
    const createGroupBtn = document.getElementById('createGroupBtn');

    const chatWithEl = document.getElementById('chatWith');
    const chatMessagesEl = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const fileBtn = document.getElementById('fileBtn');
    const fileInput = document.getElementById('fileInput');

    const videoCallBtn = document.getElementById('videoCallBtn');
    const audioCallBtn = document.getElementById('audioCallBtn');

    const callModal = document.getElementById('callModal');
    const closeCallModal = document.getElementById('closeCallModal');
    const endCallBtn = document.getElementById('endCallBtn');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    /***** Utility Functions *****/
    // Compute a unique conversationId for one-to-one chat (alphabetically sorted)
    function getConversationId(participants) {
      return participants.sort().join('_');
    }
    // Append message to a conversation and update UI if current conversation matches
    function appendMessage(convoId, sender, messageObj) {
      if (!conversations[convoId]) conversations[convoId] = [];
      conversations[convoId].push(messageObj);
      // If the current conversation is open, display message
      if (currentConversation && currentConversation.id === convoId) {
        displayMessage(messageObj);
      }
      // Optionally: store conversations in localStorage
    }
    // Display a single message in chat area
    function displayMessage(msg) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message');
      if(msg.sender === username) {
        msgDiv.classList.add('self');
      } else if(msg.type === 'system') {
        msgDiv.classList.add('system');
      } else {
        msgDiv.classList.add('peer');
      }
      // For file messages, show image if image, else show link
      if(msg.type === 'file') {
        if(msg.fileType.startsWith("image/")) {
          msgDiv.innerHTML = `<strong>${msg.sender}</strong> (${msg.time}):<br><img src="${msg.fileData}" alt="${msg.fileName}" style="max-width:200px;">`;
        } else {
          msgDiv.innerHTML = `<strong>${msg.sender}</strong> (${msg.time}):<br><a href="${msg.fileData}" download="${msg.fileName}">${msg.fileName}</a>`;
        }
      } else {
        msgDiv.innerHTML = `<strong>${msg.sender}</strong> (${msg.time}):<br>${msg.text}`;
      }
      chatMessagesEl.appendChild(msgDiv);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }
    // Clear chat messages UI
    function clearChatMessages() {
      chatMessagesEl.innerHTML = "";
    }
    // Toggle theme on body (light/dark)
    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
    }

    /***** Login & PeerJS Initialization *****/
    loginButton.addEventListener('click', () => {
      const selectedAccount = accountSelect.value;
      const pwd = passwordInput.value.trim();
      // Default password for each account is the account name itself
      if(pwd !== selectedAccount) {
        alert("ভুল পাসওয়ার্ড!");
        return;
      }
      userRole = selectedAccount;
      username = selectedAccount; // Default; later, user may change via Profile button (if implemented)
      // Initialize PeerJS with id = userRole.
      peer = new Peer(userRole, { debug: 2 });
      // Handle duplicate login: if the id is already taken, error event is fired.
      peer.on('error', err => {
        if(err.type === 'unavailable-id'){
          alert("এই একাউন্টে ইতোমধ্যে লগইন আছে!");
          peer.destroy();
        } else {
          console.error(err);
        }
      });
      peer.on('open', id => {
        console.log("Peer ID:", id);
        // Show main app UI and hide login
        loginSection.style.display = "none";
        appSection.style.display = "flex";
        initializeContacts();
      });
      // Incoming data connection from other peers
      peer.on('connection', conn => {
        setupConnection(conn);
      });
      // Incoming call
      peer.on('call', call => {
        currentCall = call;
        // For incoming call, answer automatically using proper constraints
        const constraints = (call.metadata && call.metadata.type === "audio") ? { audio: true } : { video: true, audio: true };
        navigator.mediaDevices.getUserMedia(constraints)
          .then(stream => {
            localStream = stream;
            localVideo.srcObject = stream;
            call.answer(stream);
            openCallModal();
            call.on('stream', remoteStream => {
              remoteVideo.srcObject = remoteStream;
            });
          })
          .catch(err => {
            console.error("মিডিয়া এক্সেস সমস্যাঃ", err);
          });
      });
    });

    /***** Connection Setup *****/
    // Setup a data connection with a peer
    function setupConnection(conn) {
      conn.on('open', () => {
        console.log("Connected with", conn.peer);
      });
      conn.on('data', data => {
        try {
          const msgObj = JSON.parse(data);
          // Ensure message has conversationId; if not, compute for one-to-one
          if(!msgObj.conversationId && msgObj.sender && msgObj.sender !== username) {
            msgObj.conversationId = getConversationId([msgObj.sender, username]);
          }
          appendMessage(msgObj.conversationId, msgObj.sender, msgObj);
        } catch(e) {
          console.error("Invalid message format", e);
        }
      });
      conn.on('error', err => {
        console.error("Connection error:", err);
      });
      // Save connection in global connections
      connections[conn.peer] = conn;
    }
    // Get (or create) a connection to a given peer
    function getConnection(peerId) {
      if(connections[peerId] && connections[peerId].open) return connections[peerId];
      const conn = peer.connect(peerId);
      setupConnection(conn);
      return conn;
    }

    /***** Contacts & Conversations *****/
    // Initialize contact list: list other accounts from account1 to account6 except self.
    function initializeContacts() {
      contactListEl.innerHTML = "";
      const allAccounts = ["account1", "account2", "account3", "account4", "account5", "account6"];
      allAccounts.forEach(acc => {
        if(acc === userRole) return;
        const li = document.createElement('li');
        li.textContent = acc;
        li.addEventListener('click', () => {
          // For one-to-one chat, conversationId is sorted pair.
          const convoId = getConversationId([userRole, acc]);
          currentConversation = { id: convoId, participants: [acc] };
          chatWithEl.textContent = acc;
          // Highlight selected contact
          document.querySelectorAll('aside.contacts li').forEach(item => item.classList.remove('active'));
          li.classList.add('active');
          // Load conversation messages (if any)
          clearChatMessages();
          if(conversations[convoId]) {
            conversations[convoId].forEach(m => displayMessage(m));
          }
        });
        contactListEl.appendChild(li);
      });
    }
    // For group chat: prompt user to enter comma separated account names (from available accounts)
    createGroupBtn.addEventListener('click', () => {
      const input = prompt("গ্রুপে কারা থাকবে? (কমা দিয়ে আলাদা করে লিখুন, যেমন: account2,account3)");
      if(!input) return;
      const members = input.split(',').map(s => s.trim()).filter(s => s && s !== userRole);
      if(members.length < 1) {
        alert("কমপক্ষে একজন অন্য সদস্য আবশ্যক!");
        return;
      }
      // Conversation id for group: prefix with "group_"
      const convoId = "group_" + getConversationId([userRole, ...members]);
      currentConversation = { id: convoId, participants: members };
      chatWithEl.textContent = "গ্রুপ: " + members.join(', ');
      // Optionally, add group to contact list
      clearChatMessages();
      if(conversations[convoId]) {
        conversations[convoId].forEach(m => displayMessage(m));
      }
    });

    /***** Chat Message Functions *****/
    sendChatBtn.addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') sendChatMessage();
    });
    function sendChatMessage() {
      const text = chatInput.value.trim();
      if(text === "" || !currentConversation) return;
      const time = new Date().toLocaleTimeString();
      const msgObj = { conversationId: currentConversation.id, sender: username, text, time, type: 'text' };
      // Append message locally
      appendMessage(currentConversation.id, username, msgObj);
      // Send message to each participant
      currentConversation.participants.forEach(peerId => {
        const conn = getConnection(peerId);
        if(conn && conn.open) {
          conn.send(JSON.stringify(msgObj));
        }
      });
      chatInput.value = "";
    }
    // File sending
    fileBtn.addEventListener('click', () => {
      fileInput.click();
    });
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if(!file || !currentConversation) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileData = e.target.result;
        const time = new Date().toLocaleTimeString();
        const msgObj = {
          conversationId: currentConversation.id,
          sender: username,
          type: 'file',
          fileName: file.name,
          fileData,
          fileType: file.type,
          time
        };
        appendMessage(currentConversation.id, username, msgObj);
        // Send file message to each participant
        currentConversation.participants.forEach(peerId => {
          const conn = getConnection(peerId);
          if(conn && conn.open) {
            conn.send(JSON.stringify(msgObj));
          }
        });
      };
      reader.readAsDataURL(file);
      fileInput.value = "";
    });

    /***** Call Functions *****/
    let localStream = null;
    let currentCall = null;
    // Start call (video or audio) with current conversation participants (only for one-to-one here)
    function startCall(isVideo = true) {
      if(!currentConversation || currentConversation.participants.length < 1) {
        alert("প্রথমে একজন কন্টাক্ট নির্বাচন করুন");
        return;
      }
      const callType = isVideo ? "video" : "audio";
      const constraints = isVideo ? { video: true, audio: true } : { audio: true };
      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          localStream = stream;
          localVideo.srcObject = stream;
          openCallModal();
          // For each participant in the conversation, initiate call
          currentConversation.participants.forEach(peerId => {
            const call = peer.call(peerId, stream, { metadata: { type: callType, conversationId: currentConversation.id } });
            call.on('stream', remoteStream => {
              remoteVideo.srcObject = remoteStream;
            });
            currentCall = call;
          });
        })
        .catch(err => {
          console.error("মিডিয়া এক্সেস সমস্যাঃ", err);
        });
    }
    videoCallBtn.addEventListener('click', () => startCall(true));
    audioCallBtn.addEventListener('click', () => startCall(false));
    // Modal functions for call
    function openCallModal() {
      callModal.style.display = "block";
    }
    function closeCallModalFunc() {
      callModal.style.display = "none";
      endCall();
    }
    closeCallModal.addEventListener('click', closeCallModalFunc);
    endCallBtn.addEventListener('click', closeCallModalFunc);
    function endCall() {
      if(localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      if(currentCall) {
        currentCall.close();
        currentCall = null;
      }
    }

    /***** Profile Button: Theme Toggle *****/
    profileBtn.addEventListener('click', () => {
      toggleTheme();
    });

  </script>
</body>
</html>
